name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["*"]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov flake8 mypy

      - name: Static analysis (flake8)
        run: |
          flake8 backend/app backend/engine || true

      - name: Type check (mypy)
        run: |
          mypy --ignore-missing-imports backend/app || true

      - name: Run tests with coverage
        env:
          ENVIRONMENT: test
          SECURITY_TEST_MODE: "1"
        run: |
          pytest -q --cov=backend/app --cov-report=xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Build backend image
        run: |
          docker build -t compliancepulse-backend -f backend/Dockerfile .

      - name: Build frontend image
        run: |
          docker build -t compliancepulse-frontend -f frontend/Dockerfile .

      - name: Healthcheck container
        run: |
          docker run -d --rm -p 8000:8000 --name cp-backend compliancepulse-backend
          # Wait a bit then curl health
          for i in {1..10}; do sleep 3; if curl -fsS http://localhost:8000/health; then exit 0; fi; done; exit 1

      - name: Smoke test via compose (headless)
        run: |
          docker compose version || true
          # Basic compose validation if available
          docker compose -f docker-compose.yml config > /dev/null

      - name: Cleanup
        if: always()
        run: |
          docker rm -f cp-backend || true
